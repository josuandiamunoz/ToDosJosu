pipeline { 

	agent none
	options { skipDefaultCheckout() } 
	
	stages { 
		stage('Get Code') {
			agent {label 'agent3'}		
			steps { 
				sh 'whoami'
				sh 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
				git branch: 'develop', url: 'https://github.com/josuandiamunoz/ToDosJosu.git'
				stash name:'code', includes:'**'
			} 
		} 
		stage('Static tests') { 
			agent {label 'agent1'}	
			steps { 
				sh 'whoami'
				sh 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
				unstash name:'code'
				sh ''' flake8 --exit-zero --format=pylint app >flake8.out ''' 
				sh ''' bandit -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}" || true ''' 
				recordIssues tools: [flake8(pattern: 'flake8.out')]
				recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')] 
			} 
		} 
		
		stage('Deploy') { 
			agent {label 'agent3'}		
			steps { 
				sh 'whoami'
				sh 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
				sh ''' 
					sam build 
					sam deploy --config-env staging --debug --no-confirm-changeset --no-fail-on-empty-changeset 
				''' 
			} 
		} 
		stage('Rest Test') {
			agent {label 'agent2'}	
			steps {
				sh 'whoami'
				sh 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
				script {
					def BASE_URL = sh( script: "aws cloudformation describe-stacks --stack-name todo-list-aws-staging --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --region us-east-1 --output text",
						returnStdout: true).trim()
					withEnv(["BASE_URL=${BASE_URL}"]) {
						sh '''
							set -e  # cualquier fallo detiene el script y marca el stage como failed				


							CREATE_RESPONSE=$(curl -s -f -X POST "$BASE_URL/todos" \
							  -H "Content-Type: application/json" \
							  -d '{"text":"Learn Serverless Test"}')
							  echo

							TODO_ID=$(echo "$CREATE_RESPONSE" | jq -r '.body | fromjson | .id')

							if [ -z "$TODO_ID" ] || [ "$TODO_ID" = "null" ]; then
							  echo "‚ùå No ID returned from POST"
							  exit 1
							fi

							curl -s -f "$BASE_URL/todos"	
							echo

							curl -s -f "$BASE_URL/todos/$TODO_ID"
							echo

							curl -s -f -X PUT "$BASE_URL/todos/$TODO_ID" \
							  -H "Content-Type: application/json" \
							  -d '{"text":"Learn python and more","checked":true}'
							  echo

							curl -s -f -X DELETE "$BASE_URL/todos/$TODO_ID"
							echo

						'''
					}
					
				}
			}
		} 
		
		stage('Promote') { 
			agent {label 'agent3'}		
			steps { 
				sh 'whoami'
				sh 'hostname'
				echo WORKSPACE
				echo "NODE_NAME = ${env.NODE_NAME}"
				withCredentials([usernamePassword(
					credentialsId: 'PAT_Jenkins_AWS',
					usernameVariable: 'GIT_USER',
					passwordVariable: 'GIT_TOKEN'
				)]) {
					sh '''
						git config user.email "jenkins@test.com"
						git config user.name "Jenkins"
						git config merge.ours.driver true
						
						git fetch origin
						git checkout master 
						git merge origin/develop 
						
						git push https://$GIT_USER:$GIT_TOKEN@github.com/josuandiamunoz/ToDosJosu.git master
					'''
				}
			}
		} 
	}
}